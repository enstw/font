# .github/workflows/build-release.yml
#
# Main build and release workflow for ENS Font.
#
# Triggered by:
#   - repository_dispatch (event: upstream-updated) from check-upstream.yml
#   - workflow_dispatch for manual builds
#
# Produces four TTF files (Regular, Bold, Italic, Bold Italic) packaged
# into a ZIP archive and published as a GitHub Release.
#
# Required secrets:
#   BOT_PAT  - Fine-grained PAT with: contents:write
#
# Job dependency graph:
#   resolve-params
#       |
#   download-fonts
#       |
#   build (matrix x4, parallel)
#       |
#   release

name: Build and Release ENS Font

on:
  repository_dispatch:
    types: [upstream-updated]

  workflow_dispatch:
    inputs:
      git_tag:
        description: "Git tag to create (leave blank to read from versions.json)"
        required: false
      lxgw_tag:
        description: "LXGW WenKai release tag (e.g. v1.521)"
        required: false
      nerd_tag:
        description: "Nerd Fonts release tag (e.g. v3.4.0)"
        required: false

permissions:
  contents: write

env:
  PYTHON_VERSION: "3.12"

# ---------------------------------------------------------------------------
# Job 1: Resolve build parameters
# ---------------------------------------------------------------------------
jobs:
  resolve-params:
    runs-on: ubuntu-latest
    outputs:
      git_tag:      ${{ steps.params.outputs.git_tag }}
      version:      ${{ steps.params.outputs.version }}
      lxgw_tag:     ${{ steps.params.outputs.lxgw_tag }}
      nerd_tag:     ${{ steps.params.outputs.nerd_tag }}
      lxgw_changed: ${{ steps.params.outputs.lxgw_changed }}
      nerd_changed: ${{ steps.params.outputs.nerd_changed }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve parameters
        id: params
        run: |
          # Priority: dispatch payload > workflow_dispatch inputs > versions.json
          GIT_TAG="${{ github.event.client_payload.git_tag || github.event.inputs.git_tag }}"
          LXGW_TAG="${{ github.event.client_payload.lxgw_tag || github.event.inputs.lxgw_tag }}"
          NERD_TAG="${{ github.event.client_payload.nerd_tag || github.event.inputs.nerd_tag }}"

          # Fallback: read from versions.json
          if [ -z "$GIT_TAG" ]; then
            GIT_TAG=$(python3 -c "import json; d=json.load(open('versions.json')); print(d['packaging']['git_tag'])")
          fi
          if [ -z "$LXGW_TAG" ]; then
            LXGW_TAG=$(python3 -c "import json; d=json.load(open('versions.json')); print(d['upstream']['lxgw_wenkai']['tag'])")
          fi
          if [ -z "$NERD_TAG" ]; then
            NERD_TAG=$(python3 -c "import json; d=json.load(open('versions.json')); print(d['upstream']['meslo_nerd']['tag'])")
          fi

          # Extract X.Y.Z from tag (strip leading 'v', take up to first '_')
          VERSION=$(echo "$GIT_TAG" | sed 's/^v//' | cut -d'_' -f1)

          # Detect which upstream changed.
          # check_versions.py stores the previous tags in versions.json (prev_lxgw_tag /
          # prev_nerd_tag) before overwriting, and also passes them via dispatch payload.
          # Fallback chain: payload → versions.json → empty string (= both changed)
          PREV_LXGW="${{ github.event.client_payload.prev_lxgw_tag }}"
          PREV_NERD="${{ github.event.client_payload.prev_nerd_tag }}"

          if [ -z "$PREV_LXGW" ]; then
            PREV_LXGW=$(python3 -c "import json; d=json.load(open('versions.json')); print(d['packaging'].get('prev_lxgw_tag', ''))")
          fi
          if [ -z "$PREV_NERD" ]; then
            PREV_NERD=$(python3 -c "import json; d=json.load(open('versions.json')); print(d['packaging'].get('prev_nerd_tag', ''))")
          fi

          LXGW_CHANGED="false"
          NERD_CHANGED="false"
          { [ -z "$PREV_LXGW" ] || [ "$LXGW_TAG" != "$PREV_LXGW" ]; } && LXGW_CHANGED="true"
          { [ -z "$PREV_NERD"  ] || [ "$NERD_TAG"  != "$PREV_NERD"  ]; } && NERD_CHANGED="true"
          # Fallback: if both still false (shouldn't happen), show both
          if [ "$LXGW_CHANGED" = "false" ] && [ "$NERD_CHANGED" = "false" ]; then
            LXGW_CHANGED="true"
            NERD_CHANGED="true"
          fi

          echo "git_tag=$GIT_TAG"           >> "$GITHUB_OUTPUT"
          echo "version=$VERSION"           >> "$GITHUB_OUTPUT"
          echo "lxgw_tag=$LXGW_TAG"         >> "$GITHUB_OUTPUT"
          echo "nerd_tag=$NERD_TAG"          >> "$GITHUB_OUTPUT"
          echo "lxgw_changed=$LXGW_CHANGED" >> "$GITHUB_OUTPUT"
          echo "nerd_changed=$NERD_CHANGED"  >> "$GITHUB_OUTPUT"

          echo "--- Build parameters ---"
          echo "  git_tag      : $GIT_TAG"
          echo "  version      : $VERSION"
          echo "  lxgw_tag     : $LXGW_TAG  (prev: $PREV_LXGW, changed: $LXGW_CHANGED)"
          echo "  nerd_tag     : $NERD_TAG   (prev: $PREV_NERD,  changed: $NERD_CHANGED)"

# ---------------------------------------------------------------------------
# Job 2: Download upstream font sources
# ---------------------------------------------------------------------------
  download-fonts:
    needs: resolve-params
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download LXGW WenKai Mono TTF files
        run: |
          mkdir -p fonts/wenkai
          BASE_URL="https://github.com/lxgw/LxgwWenKai/releases/latest/download"
          # WenKai Mono v1.521 ships: Regular, Medium, Light (no Bold)
          # Medium is used as the CJK base for Bold/Bold Italic styles
          for VARIANT in Regular Medium Light; do
            FILE="LXGWWenKaiMono-${VARIANT}.ttf"
            echo "Downloading $FILE ..."
            curl -fsSL "${BASE_URL}/${FILE}" -o "fonts/wenkai/${FILE}"
          done
          echo "LXGW WenKai downloads:"
          ls -lh fonts/wenkai/

      - name: Download Nerd Fonts Meslo archive
        run: |
          mkdir -p fonts/meslo
          ARCHIVE="Meslo.tar.xz"
          URL="https://github.com/ryanoasis/nerd-fonts/releases/latest/download/${ARCHIVE}"
          echo "Downloading ${ARCHIVE} ..."
          curl -fsSL "$URL" -o "/tmp/${ARCHIVE}"
          echo "Extracting Meslo fonts ..."
          tar -xJf "/tmp/${ARCHIVE}" -C fonts/meslo/
          echo "MesloLGM fonts found:"
          ls fonts/meslo/MesloLGMNerdFont-*.ttf

      - name: Upload font sources as artifact
        uses: actions/upload-artifact@v4
        with:
          name: font-sources
          path: fonts/
          retention-days: 1

# ---------------------------------------------------------------------------
# Job 3: Build merged fonts (4-way matrix, runs in parallel)
# ---------------------------------------------------------------------------
  build:
    needs: [resolve-params, download-fonts]
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false   # Build all styles even if one fails
      matrix:
        include:
          - style:       Regular
            wenkai_file: LXGWWenKaiMono-Regular.ttf
            meslo_file:  MesloLGMNerdFont-Regular.ttf
            output_file: ENSFont-Regular.ttf

          - style:       Bold
            # WenKai has no Bold; Medium is the closest weight
            wenkai_file: LXGWWenKaiMono-Medium.ttf
            meslo_file:  MesloLGMNerdFont-Bold.ttf
            output_file: ENSFont-Bold.ttf

          - style:       Italic
            # WenKai has no italic; Regular used as CJK base
            wenkai_file: LXGWWenKaiMono-Regular.ttf
            meslo_file:  MesloLGMNerdFont-Italic.ttf
            output_file: ENSFont-Italic.ttf

          - style:       Bold Italic
            # WenKai has no Bold Italic; Medium used as CJK base
            wenkai_file: LXGWWenKaiMono-Medium.ttf
            meslo_file:  MesloLGMNerdFont-BoldItalic.ttf
            output_file: ENSFont-BoldItalic.ttf

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download font sources
        uses: actions/download-artifact@v4
        with:
          name: font-sources
          path: fonts/

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: scripts/requirements.txt

      - name: Install Python dependencies
        run: pip install -r scripts/requirements.txt

      - name: Build ${{ matrix.style }}
        env:
          VERSION:  ${{ needs.resolve-params.outputs.version }}
          LXGW_TAG: ${{ needs.resolve-params.outputs.lxgw_tag }}
          NERD_TAG:  ${{ needs.resolve-params.outputs.nerd_tag }}
        run: |
          mkdir -p dist

          LXGW_VER="${LXGW_TAG#v}"
          NERD_VER="${NERD_TAG#v}"

          python scripts/merge.py \
            --wenkai  "fonts/wenkai/${{ matrix.wenkai_file }}" \
            --meslo   "fonts/meslo/${{ matrix.meslo_file }}" \
            --output  "dist/${{ matrix.output_file }}" \
            --style   "${{ matrix.style }}" \
            --version "$VERSION" \
            --lxgw-version "$LXGW_VER" \
            --nerd-version "$NERD_VER"

      - name: Verify OFL compliance
        run: |
          python3 - <<'EOF'
          from fontTools.ttLib import TTFont
          import sys

          path = "dist/${{ matrix.output_file }}"
          font = TTFont(path)
          name = font["name"]

          family  = name.getDebugName(1) or ""
          ps_name = name.getDebugName(6) or ""
          version = name.getDebugName(5) or ""

          print(f"Family name    : {family}")
          print(f"PostScript name: {ps_name}")
          print(f"Version string : {version}")

          # OFL reserved name checks
          violations = []
          for reserved in ["LXGW", "霞鶩", "Klee", "Meslo"]:
              if reserved in family or reserved in ps_name:
                  violations.append(f"Reserved name '{reserved}' found in font metadata!")

          if violations:
              for v in violations:
                  print(f"OFL VIOLATION: {v}", file=sys.stderr)
              sys.exit(1)

          print("OFL compliance checks PASSED")
          EOF

      - name: Upload built font
        uses: actions/upload-artifact@v4
        with:
          name: font-${{ matrix.style }}
          path: dist/${{ matrix.output_file }}
          retention-days: 1

# ---------------------------------------------------------------------------
# Job 4: Assemble and publish GitHub Release
# ---------------------------------------------------------------------------
  release:
    needs: [resolve-params, build]
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.BOT_PAT }}

      - name: Download all built fonts
        uses: actions/download-artifact@v4
        with:
          pattern: font-*
          path: dist/
          merge-multiple: true

      - name: Create ZIP archive
        env:
          VERSION: ${{ needs.resolve-params.outputs.version }}
        run: |
          ls -lh dist/
          cd dist
          zip -j "../ENSFont-${VERSION}.zip" *.ttf
          cd ..
          zip "ENSFont-${VERSION}.zip" README.md LICENSE.md
          ls -lh "ENSFont-${VERSION}.zip"

      - name: Set up Python for release notes
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: scripts/requirements.txt

      - name: Install Python dependencies
        run: pip install -r scripts/requirements.txt

      - name: Generate release notes
        env:
          GITHUB_TOKEN: ${{ secrets.BOT_PAT }}
        run: |
          python scripts/build_release_notes.py \
            --version      "${{ needs.resolve-params.outputs.version }}" \
            --lxgw-tag     "${{ needs.resolve-params.outputs.lxgw_tag }}" \
            --nerd-tag     "${{ needs.resolve-params.outputs.nerd_tag }}" \
            --lxgw-changed "${{ needs.resolve-params.outputs.lxgw_changed }}" \
            --nerd-changed "${{ needs.resolve-params.outputs.nerd_changed }}" \
            --output       /tmp/release_notes.md \
            --github-token "$GITHUB_TOKEN"
          echo "--- Release notes preview (first 30 lines) ---"
          head -30 /tmp/release_notes.md

      - name: Create git tag
        env:
          GIT_TAG: ${{ needs.resolve-params.outputs.git_tag }}
        run: |
          git config user.name  "ENS Font Bot"
          git config user.email "bot@users.noreply.github.com"
          if ! git rev-parse "$GIT_TAG" >/dev/null 2>&1; then
            git tag -a "$GIT_TAG" -m "Release $GIT_TAG"
            git push origin "$GIT_TAG"
            echo "Created tag: $GIT_TAG"
          else
            echo "Tag $GIT_TAG already exists, skipping creation."
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.BOT_PAT }}
          tag_name: ${{ needs.resolve-params.outputs.git_tag }}
          name: "ENS Font v${{ needs.resolve-params.outputs.version }}"
          body_path: /tmp/release_notes.md
          draft: false
          prerelease: false
          files: |
            dist/ENSFont-Regular.ttf
            dist/ENSFont-Bold.ttf
            dist/ENSFont-Italic.ttf
            dist/ENSFont-BoldItalic.ttf
            ENSFont-${{ needs.resolve-params.outputs.version }}.zip
